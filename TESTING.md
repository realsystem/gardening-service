# Testing Guide

## Quick Start

### Backend Tests
```bash
pytest
```

### Frontend Tests
```bash
cd frontend
npm test
```

**That's it!** Tests run locally without Docker.

---

## Hybrid Testing Model

This project uses a **hybrid testing model**:

### ‚úÖ Local Testing (Default)
- **Backend:** Tests use in-memory SQLite databases (no PostgreSQL needed)
- **Frontend:** Tests mock API calls
- **Fast, simple, no Docker required**

### üê≥ Docker (Services Only)
Docker is used for:
- Running services (API, database, frontend)
- Manual testing and development
- CI/CD deployment verification

Docker is **NOT** used for running tests locally.

---

## Environment Configuration

The application supports multiple environments:

### `.env.local` (Local Development)
```bash
APP_ENV=local
DATABASE_URL=postgresql://gardener:password@localhost:5432/gardening_db
```
Used when running the app locally (outside Docker).

### `.env.docker` (Docker Services)
```bash
APP_ENV=docker
DATABASE_URL=postgresql://gardener:password@db:5432/gardening_db
```
Used when running services with `docker-compose up`.

### `.env.test` (Testing)
```bash
APP_ENV=test
DATABASE_URL=sqlite:///:memory:
```
Used automatically by pytest. Tests use in-memory SQLite.

---

## Running Tests

### Backend (pytest)

**Run all tests:**
```bash
pytest
```

**Run with verbose output:**
```bash
pytest -v
```

**Run specific test file:**
```bash
pytest tests/test_models.py
```

**Run specific test:**
```bash
pytest tests/test_rules.py::TestHarvestRule::test_harvest_rule_generates_task
```

**Skip coverage (faster):**
```bash
pytest --no-cov
```

**View coverage report:**
```bash
pytest  # Coverage is auto-generated
open htmlcov/index.html
```

### Frontend (Vitest)

**Run all tests:**
```bash
cd frontend
npm test
```

**Run tests in watch mode:**
```bash
npm test -- --watch
```

**Run tests with UI:**
```bash
npm test -- --ui
```

**Generate coverage:**
```bash
npm test -- --coverage
open coverage/index.html
```

---

## Test Configuration

### pytest.ini
```ini
[pytest]
# Environment automatically set to 'test'
env =
    APP_ENV=test

# Coverage automatically generated
addopts =
    --cov=app
    --cov-report=html
    --cov-fail-under=80
```

### conftest.py
All tests use **in-memory SQLite** databases via fixtures:
- `test_db` - Fresh database per test
- `client` - FastAPI test client
- No external database required

---

## Docker Usage

### Starting Services
```bash
docker-compose up
```

Services available:
- **API:** http://localhost:8080
- **Frontend:** http://localhost:3000
- **Database:** localhost:5432

### Stopping Services
```bash
docker-compose down
```

### Important
**DO NOT** run tests in Docker locally:
- ‚ùå `docker-compose exec api pytest` (slow, unnecessary)
- ‚úÖ `pytest` (fast, local)

---

## CI/CD

In continuous integration:
1. Install dependencies locally
2. Run `pytest` on the host runner
3. Run `npm test` on the host runner
4. Build Docker images for deployment
5. Optionally run smoke tests in Docker

**Tests should NEVER require Docker to pass.**

---

## Validation

The test suite includes a validation test to ensure:
- No Docker-only paths in test files
- Tests run without Docker
- APP_ENV is correctly set to 'test'

Run validation:
```bash
pytest tests/test_no_docker_dependencies.py
```

---

## Troubleshooting

### "ModuleNotFoundError" when running pytest
**Solution:** Activate your virtual environment
```bash
source venv/bin/activate  # On Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### Tests fail with database errors
**Solution:** Tests should use in-memory SQLite, not PostgreSQL
- Check `conftest.py` is in place
- Ensure `APP_ENV=test` is set (automatic via pytest.ini)

### Coverage report missing
**Solution:** Coverage is auto-generated by pytest.ini
```bash
pytest  # Generates htmlcov/ directory
open htmlcov/index.html
```

### Need to run tests in Docker anyway
**Not recommended, but if necessary:**
```bash
# This is SLOWER than local pytest
docker-compose run --rm api pytest
```

---

## Best Practices

### ‚úÖ DO
- Run tests locally with `pytest` and `npm test`
- Use Docker for running services
- Keep tests fast with in-memory databases
- Check coverage reports regularly

### ‚ùå DON'T
- Run tests in Docker for local development
- Reference Docker paths in tests
- Require external databases for tests
- Skip test coverage checks

---

## Coverage Goals

- **Backend:** 80%+ (enforced by pytest)
- **Frontend:** 80%+ (recommended)
- **Integration:** All critical workflows

Current coverage:
- Backend: ~90%
- Frontend: ~85%
- Integration: 100% of critical paths
